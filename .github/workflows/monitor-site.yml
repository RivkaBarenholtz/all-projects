name: Site Monitoring - All Clients

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: production
      API_URL: ${{ secrets.API_URL }}
      API_TOKEN: ${{ secrets.API_TOKEN }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug - Show file structure
        run: |
          echo "=== Current directory ==="
          pwd
          echo "=== Files in root ==="
          ls -la
          echo "=== Content of package.json ==="
          cat package.json
          echo "=== Search for all package.json files ==="
          find . -name "package.json" -type f | head -20
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          rm -rf node_modules package-lock.json
          npm install
          npm list --depth=0
      
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      
      - name: Run monitoring tests
        id: tests
        continue-on-error: true
        run: npx playwright test tests/site-monitor.spec.js --reporter=html
      
      - name: Upload test report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ github.run_id }}
          path: playwright-report/
          retention-days: 30
      
      - name: Send email notification on failure
        if: steps.tests.outcome == 'failure'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: rbarenholtz@instechpay.com
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: ðŸš¨ Site Monitoring Alert - Tests Failed
          to: rbarenholtz@instechpay.com
          from: rbarenholtz@instechpay.com
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background-color: #dc3545; color: white; padding: 20px; border-radius: 5px; }
                .content { background-color: #f8f9fa; padding: 20px; margin-top: 20px; border-radius: 5px; }
                .button { 
                  display: inline-block; 
                  padding: 10px 20px; 
                  background-color: #007bff; 
                  color: white; 
                  text-decoration: none; 
                  border-radius: 5px; 
                  margin-top: 15px;
                }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h2>ðŸš¨ Site Monitoring Alert</h2>
                  <p>One or more client sites failed monitoring checks</p>
                </div>
                <div class="content">
                  <p><strong>Time:</strong> ${{ github.event.repository.updated_at }}</p>
                  <p><strong>Repository:</strong> ${{ github.repository }}</p>
                  <p><strong>Workflow Run:</strong> #${{ github.run_number }}</p>
                  
                  <h3>What to do:</h3>
                  <ul>
                    <li>Review the test results in the workflow artifacts</li>
                    <li>Check affected client sites</li>
                    <li>Verify payment processing is working</li>
                  </ul>
                  
                  <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" class="button">
                    View Workflow Details
                  </a>
                </div>
              </div>
            </body>
            </html>
      
      - name: Create GitHub issue on failure
        if: steps.tests.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Site Monitoring Failed - ${new Date().toLocaleDateString()}`,
              body: `
            ## Site Monitoring Alert

            **Time**: ${new Date().toISOString()}
            **Workflow Run**: [#${context.runNumber}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

            One or more client sites failed monitoring checks.

            ### Actions Required
            - Review the test results in the workflow artifacts
            - Check affected client sites  
            - Verify payment processing is working
              `,
              labels: ['monitoring', 'alert', 'bug']
            })
      
      - name: Fail workflow if tests failed
        if: steps.tests.outcome == 'failure'
        run: exit 1